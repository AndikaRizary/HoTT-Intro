\section{Set quotients}

In this section we construct the quotient of a type by an equivalence relation. By an equivalence relation we understand a binary relation $R:A\to(A\to\prop)$ which is reflexive, symmetric, and transitive. In particular, we note that equivalence relations take values in $\prop$. The quotient $A/R$ is constructed as the type of equivalence classes, which is just the image of the map $R:A\to (A\to\prop)$. Thus, our construction of the quotient by an equivalence relation is very much like the classical construction of a quotient set.

However, there is a subtle issue. What is the universe level of the quotient $A/R$? Let us suppose that $\UU$ is a universe that contains $A$ and each $R(x,y)$. Then $\prop$, the type of propositions in $\UU$, is a type in the universe $\UU^+$, constructed in \cref{rmk:universe-constructions}. Therefore the type $\prop^A$ as well as the quotient $A/R$ are also types in $\UU^+$. That seems unfortunate, because in Zermelo-Fraenkel set theory the quotient of a set by an equivalence relation is an ordinary set, and not a more general class.

In Zermelo-Fraenkel set theory quotients are are sets because of the axiom schema of replacement. The replacement axioms assert that the image of any function is again a set. This leads us to wonder about a type theoretical variant of the replacement axioms. Indeed, there is such a variant. The type theoretic replacement property asserts that for any map $f:A\to B$ from a type $A$ in $\UU$ to a type $B$ of which the \emph{identity types} are equivalent to types in $\UU$, the image of $f$ is also equivalent to a type in $\UU$. Moreover, the type theoretic replacement property is a theorem! We prove it in \cref{thm:replacement}, using the univalence axiom and a new construction of the image of a map.

\subsection{Equivalence relations}

\begin{defn}\label{defn:eq_rel}
Let $R:A\to (A\to\prop)$ be a binary relation valued in the propositions. We say that $R$ is an \define{equivalence relation}\index{equivalence relation} if $R$ comes equipped with
\begin{align*}
\rho & : \prd{x:A}R(x,x) \\
\sigma & : \prd{x,y:A} R(x,y)\to R(y,x) \\
\tau & : \prd{x,y,z:A} R(x,y)\to (R(y,z)\to R(x,z)),
\end{align*}
witnessing that $R$ is reflexive, symmetric, and transitive.
\end{defn}

\begin{defn}
  Let $R:A\to (A\to\prop)$ be an equivalence relation. The \define{equivalence class} of $x:A$ is defined to be
  \begin{equation*}
    [x]_R\defeq R(x).
  \end{equation*}
  More generally, a subtype $P:A\to \prop$ is said to be an \define{equivalence class} if it satisfies
  \begin{equation*}
    \mathsf{is\usc{}equivalence\usc{}class}(P)\defeq\exists_{(x:A)}P=R(x).
  \end{equation*}
  Furthermore, we define $A/R$ to be the type of equivalence classes, i.e., we define
  \begin{equation*}
    A/R\defeq \sm{P:A\to\prop}\mathsf{is\usc{}equivalence\usc{}class}(P).
  \end{equation*}
\end{defn}

In other words, $A/R$ is the image of the map $[{-}]_R:A\to (A\to\prop)$. In the following proposition we characterize the identity type of $A/R$. As a corollary, we obtain equivalences
\begin{equation*}
  ([x]_R=[y]_R)\simeq R(x,y),
\end{equation*}
justifying that the quotient $A/R$ is defined to be the type of equivalence classes. Note that in our characterization of the identity type of $A/R$ we make use of the univalence axiom.

\begin{prp}\label{prp:eq-quotient}
  Let $R:A\to (A\to\prop)$ be an equivalence relation. Furthermore, consider $x:A$ and an equivalence class $P$. Then the canonical map
  \begin{equation*}
    ([x]_R=P)\to P(x)
  \end{equation*}
  is an equivalence.
\end{prp}

\begin{proof}
  By \cref{thm:id_fundamental} it suffices to show that the total space
  \begin{equation*}
    \sm{P:A/R}P(x)
  \end{equation*}
  is contractible. The center of contraction is of course $[x]_R$, which satisfies $[x]_R(x)$ by reflexivity of $R$. It remains to construct a contraction. Since $\sm{P:A/R}P(x)$ is a subtype of $A/R$, we construct a contraction by showing that
  \begin{equation*}
    [x]_R=P
  \end{equation*}
  whenever $P(x)$ holds. Recall that $P$ is an equivalence relation, i.e., that there exists a $y:A$ such that $P=[y]_R$. Note that our goal is a proposition, so we may assume that we have such a $y$. Then we obtain that $R(x,y)$ holds from the assumption that $P(x)$ holds. Thus, we have to show that
  \begin{equation*}
    [x]_R=[y]_R
  \end{equation*}
  given that $R(x,y)$ holds. By function extensionality and the univalence axiom, it is equivalent to show that
  \begin{equation*}
    \prd{z:A}R(x,z)\simeq R(y,z)
  \end{equation*}
  We get a function $R(x,z)\to R(y,z)$ by transitivity, since $R(y,x)$ holds by symmetry. Conversely, we get a function $R(y,z)\to R(x,z)$ directly by transitivity. Thus, we obtain that
  \begin{equation*}
    R(x,z)\leftrightarrow R(y,z)
  \end{equation*}
  for any $z:A$, which is sufficient to prove that they are equivalent because $R$ is valued in $\prop$.
\end{proof}

\begin{cor}
  Consider an equivalence relation $R$ on a type $A$, and let $x,y:A$. Then there is an equivalence
  \begin{equation*}
    ([x]_R=[y]_R)\simeq R(x,y).
  \end{equation*}
\end{cor}

\begin{proof}
  By \cref{prp:eq-quotient} we have an equivalence
  \begin{equation*}
    ([x]_R=[y]_R)\simeq R(y,x).
  \end{equation*}
  Moreover, $R(y,x)$ is equivalent to $R(x,y)$ by symmetry of $R$.
\end{proof}

\begin{comment}
The notion of $0$-equivalence relation which we defined in \cref{defn:eq_rel} fits in a hierarchy of `$n$-equivalence relations'\index{n-equivalence relation@{$n$-equivalence relation}}, the study of which is a research topic on its own. However, we already know an example of a relation that should count as an `$\infty$-equivalence relation'\index{infinity-equivalence relation@{$\infty$-equivalence relation}}: the identity type. Analogous to \cref{thm:equivalence_classes}, the following theorem shows that the canonical map
\begin{equation*}
(x=y)\to (\idtypevar{A}(x)=\idtypevar{A}(y))
\end{equation*}
is an equivalence, for any $x,y:A$. In other words, $\idtypevar{A}(x)$ can be thought of as the equivalence class of $x$ with respect to the relation $\idtypevar{A}$.

\begin{thm}
Assuming the univalence axiom on $\UU$, the map
\begin{equation*}
\idtypevar{A}:A\to (A\to\UU)
\end{equation*}
is an embedding, for any type $A:\UU$.\index{identity type!is an embedding}
\end{thm}

\begin{proof}
Let $a:A$. By function extensionality it suffices to show that the canonical map
\begin{equation*}
(a=b)\to \idtypevar{A}(a)\htpy\idtypevar{A}(b)
\end{equation*}
that sends $\refl{a}$ to $\lam{x}\refl{(a=x)}$ is an equivalence for every $b:A$, and by univalence it therefore suffices to show that the canonical map
\begin{equation*}
(a=b)\to \prd{x:A}\eqv{(a=x)}{(b=x)}
\end{equation*}
that sends $\refl{a}$ to $\lam{x}\idfunc[(a=x)]$ is an equivalence for every $b:B$. To do this we employ the type theoretic Yoneda lemma, \cref{thm:yoneda}.

By the type theoretic Yoneda lemma\index{Yoneda lemma} we have an equivalence
\begin{equation*}
\Big(\prd{x:A} (b=x)\to (a=x)\Big)\to (a=b)
\end{equation*}
given by $\lam{f} f(b,\refl{b})$, for every $b:A$. Note that any family of maps $\prd{x:A}(b=x)\to (a=x)$ induces an equivalence of total spaces by \cref{ex:contr_equiv}, since their total spaces are are both contractible by \cref{cor:contr_path}. It follows that we have an equivalence
\begin{equation*}
\varphi_b:\Big(\prd{x:A} \eqv{(b=x)}{(a=x)}\Big)\to (a=b)
\end{equation*}
given by $\lam{f} f(b,\refl{b})$, for every $b:A$. 

Note that $\varphi_a(\lam{x}\idfunc[(a=x)])\jdeq\refl{a}$. Therefore it follows by another application of \cref{thm:yoneda} that the unique family of maps 
\begin{equation*}
\alpha_b:(a=b)\to \Big(\prd{x:A} \eqv{(b=x)}{(a=x)}\Big)
\end{equation*}
that satisfies $\alpha_a(\refl{a})=\lam{x}\idfunc[(a=x)]$ is a family of sections of $\varphi$. 
It follows that $\alpha$ is a family of equivalences. Now the proof is completed by reverting the direction of the family of equivalences in the codomain.
\end{proof}
\end{comment}

\subsection{The universal property of set quotients}

The quotient $A/R$ is constructed as the image of $R$, so we obtain a commuting triangle
\begin{equation*}
  \begin{tikzcd}[column sep=-1em]
    A \arrow[rr,"q_R"] \arrow[dr,swap,"R"] & & A/R \arrow[dl,hook,"i_R"] \\
    \phantom{A/R} & \prop^A,
  \end{tikzcd}
\end{equation*}
and the embedding $i_R:A/R\to\prop^A$ satisfies the universal property of the image of $R$. This universal property is, however, not the usual universal property of the quotient.

\begin{defn}
  Consider a map $q:A\to B$ into a set $B$ satisfying the property that $f(x)=f(y)$ whenever $R(x,y)$ holds. We say that $q$ satisfies the \define{universal property of the set quotient by $R$} if for every map $f:A\to X$ into a set $X$ such that $f(x)=f(y)$ whenever $R(x,y)$ holds, there is a unique extension
  \begin{equation*}
    \begin{tikzcd}
      A \arrow[d,swap,"q"] \arrow[dr,"f"] \\
      B \arrow[r,densely dotted] & X.
    \end{tikzcd}
  \end{equation*}
\end{defn}

\begin{rmk}
  Formally, we express the universal property of the quotient by $R$ as follows. Consider a map $q:A\to B$ that satisfies the property that
  \begin{equation*}
    H:\prd{x,y:A}R(x,y)\to (f(x)=f(y)).
  \end{equation*}
  Then there is for any set $X$ a map
  \begin{equation*}
    q^\ast:(B\to X) \to \Big(\sm{f:A\to X}\prd{x,y:A}R(x,y)\to (f(x)=f(y))\Big).
  \end{equation*}
  This map takes a function $h:B\to X$ to the pair
  \begin{equation*}
    q^\ast(h)\defeq(h\circ q,\lam{x}{y}{r}\ap{h}{H_{x,y}(r)}).
  \end{equation*}
  The universal property of the set quotient of $R$ asserts that the map $q^\ast$ is an equivalence for every set $X$. It is important to note that the universal property of set quotients is formulated with respect to sets.
\end{rmk}

\begin{lem}
Let $R:A\to (A\to \prop)$ be an equivalence relation\index{equivalence relation}, for $A:\UU$, and consider a commuting triangle
\begin{equation*}
\begin{tikzcd}[column sep=tiny]
A \arrow[rr,"q"] \arrow[dr,swap,"R"] & & U \arrow[dl,"m"] \\
& \prop^A
\end{tikzcd}
\end{equation*}
with $H:R\htpy m\circ q$, where $m$ is an embedding. Then we have
\begin{equation*}
\prd{x,y:A}R(x,y)\to (q(x)=q(y)).
\end{equation*}
\end{lem}

\begin{thm}\label{thm:quotient_up}
Let $R:A\to (A\to \prop)$ be an equivalence relation\index{equivalence relation}, for $A:\UU$, and consider a commuting triangle
\begin{equation*}
\begin{tikzcd}[column sep=tiny]
A \arrow[rr,"q"] \arrow[dr,swap,"R"] & & U \arrow[dl,"m"] \\
& \prop^A
\end{tikzcd}
\end{equation*}
with $H:R\htpy m\circ q$, where $m$ is an embedding. Then the following are equivalent:
\begin{enumerate}
\item The embedding $m:U\to \prop^A$ satisfies the universal property of the image of $R$.
\item The map $q:A\to U$ satisfies the universal property of the set quotient $A/R$.
\end{enumerate}
\end{thm}

\begin{proof}
Suppose $m:U\to \prop^A$ satisfies the universal property of the image of $R$. Then it follows by \cref{thm:surjective} that the map $q:A\to U$ is surjective. Our goal is to prove that $U$ satisfies the universal property of the set quotient $A/R$. 
\end{proof}

\begin{rmk}
\cref{thm:quotient_up} suggests that we can define the quotient of an equivalence relation $R$ on a type $A$ as the image of a map. However, the type $\prop^A$ of which the quotient is a subtype is not a small type, even if $A$ is a small type.
Therefore it is not clear that the quotient $A/R$ is essentially small\index{essentially small}, as it should be. Luckily, our construction of the image of a map allows us to show that the image is indeed essentially small, using the fact that $\prop^A$ is locally small\index{locally small}.
\end{rmk}

\subsection{Type theoretic replacement}
\subsubsection{Essentially small types and maps}
It is a trivial observation, but nevertheless of fundamental importance, that by the univalence axiom the identity types of $\UU$ are equivalent to types in $\UU$, because it provides an equivalence $\eqv{(A=B)}{(\eqv{A}{B})}$, and the type $\eqv{A}{B}$ is in $\UU$ for any $A,B:\UU$. Since the identity types of $\UU$ are equivalent to types in $\UU$, we also say that the universe is \emph{locally small}.

\begin{defn}\label{defn:ess_small}
\begin{enumerate}
\item A type $A$ is said to be \define{essentially small}\index{essentially small!type} if there is a type $X:\UU$ and an equivalence $\eqv{A}{X}$. We write\index{ess_small(A)@{$\mathsf{ess\usc{}small}(A)$}}
\begin{equation*}
\mathsf{ess\usc{}small}(A)\defeq\sm{X:\UU}\eqv{A}{X}.
\end{equation*}
\item A map $f:A\to B$ is said to be \define{essentially small}\index{essentially small!map} if for each $b:B$ the fiber $\fib{f}{b}$ is essentially small.
We write\index{ess_small(f)@{$\mathsf{ess\usc{}small}(f)$}}
\begin{equation*}
\mathsf{ess\usc{}small}(f)\defeq\prd{b:B}\mathsf{ess\usc{}small}(\fib{f}{b}).
\end{equation*}
\item A type $A$ is said to be \define{locally small}\index{locally small!type} if for every $x,y:A$ the identity type $x=y$ is essentially small.
We write\index{loc_small(A)@{$\mathsf{loc\usc{}small}(A)$}}
\begin{equation*}
\mathsf{loc\usc{}small}(A)\defeq \prd{x,y:A}\mathsf{ess\usc{}small}(x=y).
\end{equation*}
\end{enumerate}
\end{defn}

\begin{lem}\label{lem:isprop_ess_small}
The type $\mathsf{ess\usc{}small}(A)$ is a proposition for any type $A$.\index{essentially small!is a proposition}
\end{lem}

\begin{proof}
Let $X$ be a type. Our goal is to show that the type
\begin{equation*}
\sm{Y:\UU}\eqv{X}{Y}
\end{equation*}
is a proposition. Suppose there is a type $X':\UU$ and an equivalence $e:\eqv{X}{X'}$, then the map
\begin{equation*}
(\eqv{X}{Y})\to (\eqv{X'}{Y})
\end{equation*}
given by precomposing with $e^{-1}$ is an equivalence. This induces an equivalence on total spaces
\begin{equation*}
\eqv{\Big(\sm{Y:\UU}\eqv{X}{Y}\Big)}{\Big(\sm{Y:\UU}\eqv{X'}{Y}\Big)}
\end{equation*}
However, the codomain of this equivalence is contractible by \cref{thm:univalence}. Thus it follows by \cref{cor:contr_prop} that the asserted type is a proposition.
\end{proof}

\begin{cor}
For each function $f:A\to B$, the type $\mathsf{ess\usc{}small}(f)$ is a proposition, and for each type $X$ the type $\mathsf{loc\usc{}small}(X)$ is a proposition.
\end{cor}

\begin{proof}
This follows from the fact that propositions are closed under dependent products, established in \cref{thm:trunc_pi}.
\end{proof}

\begin{thm}\label{thm:fam_proj}
For any small type $A:\UU$ there is an equivalence
\begin{equation*}
\mathsf{map\usc{}fam}_A:\eqv{(A\to \UU)}{\Big(\sm{X:\UU} X\to A\Big)}.
\end{equation*}
\end{thm}

\begin{proof}
Note that we have the function
\begin{equation*}
\varphi :\lam{B} \Big(\sm{x:A}B(x),\proj 1\Big) : (A\to \UU)\to \Big(\sm{X:\UU}X\to A\Big).
\end{equation*}
The fiber of this map at $(X,f)$ is by univalence and function extensionality equivalent to the type
\begin{equation*}
\sm{B:A\to \UU}{e:\eqv{(\sm{x:A}B(x))}{X}} \proj 1\htpy f\circ e.
\end{equation*}
By \cref{ex:triangle_fib} this type is equivalent to the type
\begin{equation*}
\sm{B:A\to \UU}\prd{a:A} \eqv{B(a)}{\fib{f}{a}},
\end{equation*}
and by `type theoretic choice', which was established in \cref{thm:choice}, this type is equivalent to
\begin{equation*}
\prd{a:A}\sm{X:\UU}\eqv{X}{\fib{f}{a}}.
\end{equation*}
We conclude that the fiber of $\varphi$ at $(X,f)$ is equivalent to the type $\mathsf{ess\usc{}small}(f)$. However, since $f:X\to A$ is a map between small types it is essentially small. Moreover, since being essentially small is a proposition by \cref{lem:isprop_ess_small}, it follows that $\fib{\varphi}{(X,f)}$ is contractible for every $f:X\to A$. In other words, $\varphi$ is a contractible map, and therefore it is an equivalence.
\end{proof}

\begin{rmk}
The inverse of the map
\begin{equation*}
\varphi : (A\to \UU)\to \Big(\sm{X:\UU}X\to A\Big).
\end{equation*}
constructed in \cref{thm:fam_proj} is the map $(X,f)\mapsto \fibf{f}$.
\end{rmk}

\begin{thm}\label{thm:classifier}
Let $f:A\to B$ be a map. Then there is an equivalence
\begin{equation*}
\eqv{\mathsf{ess\usc{}small}(f)}{\mathsf{is\usc{}classified}(f)},
\end{equation*}
where $\mathsf{is\usc{}classified}(f)$\index{is_classified(f)@{$\mathsf{is\usc{}classified}(f)$}} is the type of quadruples $(F,\tilde{F},H,p)$ consisting of maps
$F:B\to \UU$ and $\tilde{F}:A\to \sm{X:\UU}X$, a homotopy $H:F\circ f\htpy \proj 1\circ \tilde{F}$,  such that the commuting square
\begin{equation*}
\begin{tikzcd}
A \arrow[r,"\tilde{F}"] \arrow[d,swap,"f"] & \sm{X:\UU}X \arrow[d,"\proj 1"] \\
B \arrow[r,swap,"F"] & \UU
\end{tikzcd}
\end{equation*}
is a pullback square, as witnessed by $p$\footnote{The universal property of the pullback is not expressible by a type. However, we may take the type of $p:\isequiv(h)$, where $h:A\to B\times_\UU\big(\sm{X:\UU}X\big)$ is the map obtained by the universal property of the canonical pullback.}. If $f$ comes equipped with a term of type $\mathsf{is\usc{}classified}(f)$, we also say that $f$ is \define{classified}\index{classified by the universal family} by the universal family. 
\end{thm}

\begin{proof}
From \cref{ex:sq_fib} we obtain that the type of pairs $(\tilde{F},H)$ is equivalent to the type of fiberwise transformations
\begin{equation*}
\prd{b:B}\fib{f}{b}\to F(b).
\end{equation*}
By \cref{cor:pb_fibequiv} the square is a pullback square if and only if the induced map
\begin{equation*}
\prd{b:B}\fib{f}{b}\to F(b)
\end{equation*}
is a fiberwise equivalence. Thus the data $(F,\tilde{F},H,pb)$ is equivalent to the type of pairs $(F,e)$ where $e$ is a fiberwise equivalence from $\fibf{f}$ to $F$. By \cref{thm:choice} the type of pairs $(F,e)$ is equivalent to the type $\mathsf{ess\usc{}small}(f)$. 
\end{proof}

\begin{rmk}
For any type $A$ (not necessarily small), and any $B:A\to \UU$, the square\index{Sigma-type@{$\Sigma$-type}!as pullback of universal family}
\begin{equation*}
\begin{tikzcd}[column sep=6em]
\sm{x:A}B(x) \arrow[d,swap,"\proj 1"] \arrow[r,"{\lam{(x,y)}(B(x),y)}"] & \sm{X:\UU}X \arrow[d,"\proj 1"] \\
A \arrow[r,swap,"B"] & \UU
\end{tikzcd}
\end{equation*}
is a pullback square. Therefore it follows that for any family $B:A\to\UU$ of small types, the projection map $\proj 1:\sm{x:A}B(x)\to A$ is an essentially small map.
To see that the claim is a direct consequence of \cref{lem:pb_subst} we write the asserted square in its rudimentary form:
\begin{equation*}
%\begin{gathered}[b]
\begin{tikzcd}[column sep=6em]
\sm{x:A}\mathrm{El}(B(x)) \arrow[d,swap,"\proj 1"] \arrow[r,"{\lam{(x,y)}(B(x),y)}"] & \sm{X:\UU}\mathrm{El}(X) \arrow[d,"\proj 1"] \\
A \arrow[r,swap,"B"] & \UU.
\end{tikzcd}%\\[-\dp\strutbox]\end{gathered}\qedhere
\end{equation*}
\end{rmk}

In the following theorem we show that a type is small if and only if its diagonal is classified by $\UU$.

\begin{thm}
Let $A$ be a type. The following are equivalent:
\begin{enumerate}
\item $A$ is locally small.\index{locally small}
\item There are maps $I:A\times A\to\UU$ and $\tilde{I}:A\to\sm{X:\UU}X$, and a homotopy $H:I\circ \delta_A\htpy \proj 1\circ\tilde{I}$
such that the commuting square
\begin{equation*}
\begin{tikzcd}
A \arrow[r,"\tilde{I}"] \arrow[d,swap,"\delta_A"] & \sm{X:\UU}X \arrow[d,"\proj 1"] \\
A\times A \arrow[r,swap,"{I}"] & \UU
\end{tikzcd}
\end{equation*}
is a pullback square.\index{diagonal!of a type}
\end{enumerate}
\end{thm}

\begin{proof}
In \cref{ex:diagonal} we have established that the identity type $x=y$ is the fiber of $\delta_A$ at $(x,y):A\times A$. Therefore it follows that $A$ is locally small if and only if the diagonal $\delta_A$ is essentially small.
Now the result follows from \cref{thm:classifier}.
\end{proof}

\subsubsection{Univalent universes are object classifiers}

\begin{defn}
  Consider a map $p:E\to B$ and a map $f:X\to Y$. The type $\cart(f,p)$ of \define{cartesian morphisms} from $f$ to $p$ is the type of quadruples $(g,h,H,t)$ consisting of maps
  \begin{align*}
    g & : Y\to B \\
    h & : X\to E,
  \end{align*}
  a homotopy $H:g\circ f\htpy p\circ h$, and a term $t$ witnessing that the commuting square
  \begin{equation*}
    \begin{tikzcd}
      X \arrow[r,"h"] \arrow[d,swap,"f"] & E \arrow[d,"p"] \\
      Y \arrow[r,swap,"g"] & B
    \end{tikzcd}
  \end{equation*}
  is a pullback square.
\end{defn}

\begin{defn}
  A map $p:E\to B$ is called an \define{object classifier} if for every map $f:X\to Y$, the type $\cart(f,p)$ of cartesian morphisms
  \begin{equation*}
    \begin{tikzcd}
      X \arrow[r] \arrow[d,swap,"f"] & E \arrow[d,"p"] \\
      Y \arrow[r] & B
    \end{tikzcd}
  \end{equation*}
  from $f$ to $p$ is a proposition. 
\end{defn}

\begin{prp}
  Consider a map $p:E\to B$. The following are equivalent:
  \begin{enumerate}
  \item The map $p$ is an object classifier.
  \item The function
    \begin{equation*}
      \tr_{\fibf{p}}:(x=y)\to (\fib{p}{x}\simeq\fib{p}{y})
    \end{equation*}
    is an equivalence.
  \end{enumerate}
\end{prp}

\begin{cor}
  A universe is an object classifier if and only if it is univalent.
\end{cor}

\subsubsection{Smallness of images}
However, the construction of the fiberwise join in \cref{ex:fib_join} suggests that we can also define the image of $f$ as the infinite join power $f^{\ast\infty}$, where we repeatedly take the fiberwise join of $f$ with itself. The reasons for defining the image in this way are twofold: we will be able to use this construction to show that the set-quotients of a small type are small, and second, we many interesting types appear in this construction.

\begin{lem}
Consider a map $f:A\to X$, an embedding $m:U\to X$, and $h:\mathrm{hom}_X(f,m)$. Then the map
\begin{equation*}
\mathrm{hom}_X(\join{f}{g},m)\to \mathrm{hom}_X(g,m)
\end{equation*}
is an equivalence for any $g:B\to X$.
\end{lem}

\begin{proof}
Note that both types are propositions, so any equivalence can be used to prove the claim. Thus, we simply calculate
\begin{align*}
\mathrm{hom}_X(\join{f}{g},m) & \eqvsym \prd{x:X}\fib{\join{f}{g}}{x}\to \fib{m}{x} \\
& \eqvsym \prd{x:X}\join{\fib{f}{x}}{\fib{g}{x}}\to\fib{m}{x} \\
& \eqvsym \prd{x:X}\fib{g}{x}\to\fib{m}{x} \\
& \eqvsym \mathrm{hom}_X(g,m).
\end{align*}
The first equivalence holds by \cref{ex:triangle_fib}; the second equivalence holds by \cref{ex:fib_join}, also using \cref{ex:equiv_precomp,lem:postcomp_equiv} where we established that that pre- and postcomposing by an equivalence is an equivalence; the third equivalence holds by \cref{lem:extend_join_prop,lem:postcomp_equiv}; the last equivalence again holds by \cref{ex:triangle_fib}.
\end{proof}

For the construction of the image of $f:A\to X$ we observe that if we are given an embedding $m:U\to X$ and a map $(i,I):\mathrm{hom}_X(f,m)$, then $(i,I)$ extends uniquely along $\inr:A\to \join[X]{A}{A}$ to a map $\mathrm{hom}_X(\join{f}{f},m)$. This extension again extends uniquely along $\inr:\join[X]{A}{A}\to \join[X]{A}{(\join[X]{A}{A})}$ to a map $\mathrm{hom}_X(\join{f}{(\join{f}{f})},m)$ and so on, resulting in a diagram of the form
\begin{equation*}
\begin{tikzcd}
A \arrow[dr] \arrow[r,"\inr"] & \join[X]{A}{A} \arrow[d,densely dotted] \arrow[r,"\inr"] & \join[X]{A}{(\join[X]{A}{A})} \arrow[dl,densely dotted] \arrow[r,"\inr"] & \cdots \arrow[dll,densely dotted,bend left=10] \\
& U
\end{tikzcd}
\end{equation*}

\begin{defn}
Suppose $f:A\to X$ is a map. Then we define the \define{fiberwise join powers} 
\begin{equation*}
f^{\ast n}:A_X^{\ast n} X.
\end{equation*}
\end{defn}

\begin{constr}
Note that the operation $(B,g)\mapsto (\join[X]{A}{B},\join{f}{g})$ defines an endomorphism on the type
\begin{equation*}
\sm{B:\UU}B\to X.
\end{equation*}
We also have $(\emptyt,\ind{\emptyt})$ and $(A,f)$ of this type. For $n\geq 1$ we define
\begin{align*}
A_X^{\ast (n+1)} & \defeq \join[X]{A}{A_X^{\ast n}} \\
f^{\ast (n+1)} & \defeq \join{f}{f^{\ast n}}.\qedhere
\end{align*}
\end{constr}

\begin{defn}
We define $A_X^{\ast\infty}$ to be the sequential colimit of the type sequence
\begin{equation*}
\begin{tikzcd}
A_X^{\ast 0} \arrow[r] & A_X^{\ast 1} \arrow[r,"\inr"] & A_X^{\ast 2} \arrow[r,"\inr"] & \cdots.
\end{tikzcd}
\end{equation*}
Since we have a cocone
\begin{equation*}
\begin{tikzcd}
A_X^{\ast 0} \arrow[r] \arrow[dr,swap,"f^{\ast 0}" near start] & A_X^{\ast 1} \arrow[r,"\inr"] \arrow[d,swap,"f^{\ast 1}" near start] & A_X^{\ast 2} \arrow[r,"\inr"] \arrow[dl,swap,"f^{\ast 2}" xshift=1ex] & \cdots \arrow[dll,bend left=10] \\
& X
\end{tikzcd}
\end{equation*}
we also obtain a map $f^{\ast\infty}:A_X^{\ast\infty}\to X$ by the universal property of $A_X^{\ast\infty}$. 
\end{defn}

\begin{lem}\label{lem:finfjp_up}
Let $f:A\to X$ be a map, and let $m:U\to X$ be an embedding. Then the function
\begin{equation*}
\blank\circ \seqin_0: \mathrm{hom}_X(f^{\ast\infty},m)\to \mathrm{hom}_X(f,m)
\end{equation*}
is an equivalence. 
\end{lem}

\begin{thm}\label{lem:isprop_infjp}
For any map $f:A\to X$, the map $f^{\ast\infty}:A_X^{\ast\infty}\to X$ is an embedding that satisfies the universal property of the image inclusion of $f$.
\end{thm}

\begin{lem}
Consider a commuting square
\begin{equation*}
\begin{tikzcd}
A \arrow[r] \arrow[d] & B \arrow[d] \\
C \arrow[r] & D.
\end{tikzcd}
\end{equation*}
\begin{enumerate}
\item If the square is cartesian, $B$ and $C$ are essentially small, and $D$ is locally small, then $A$ is essentially small.
\item If the square is cocartesian, and $A$, $B$, and $C$ are essentially small, then $D$ is essentially small. 
\end{enumerate}
\end{lem}

\begin{cor}
Suppose $f:A\to X$ and $g:B\to X$ are maps from essentially small types $A$ and $B$, respectively, to a locally small type $X$. Then $A\times_X B$ is again essentially small. 
\end{cor}

\begin{lem}
Consider a type sequence
\begin{equation*}
\begin{tikzcd}
A_0 \arrow[r,"f_0"] & A_1 \arrow[r,"f_1"] & A_2 \arrow[r,"f_2"] & \cdots
\end{tikzcd}
\end{equation*}
where each $A_n$ is essentially small. Then its sequential colimit is again essentially small. 
\end{lem}

\begin{thm}
For any map $f:A\to X$ from a small type $A$ into a locally small type $X$, the image $\im(f)$ is an essentially small type.
\end{thm}

Recall that in set theory, the replacement axiom asserts that for any family of sets $\{X_i\}_{i\in I}$ indexed by a set $I$, there is a set $X[I]$ consisting of precisely those sets $x$ for which there exists an $i\in I$ such that $x\in X_i$. In other words: the image of a set-indexed family of sets is again a set. Without the replacement axiom, $X[I]$ would be a class. In the following corollary we establish a type-theoretic analogue of the replacement axiom: the image of a family of small types indexed by a small type is again (essentially) small.

\begin{thm}\label{thm:replacement}
  For any map $f:A\to B$ from an essentially small type $A$ into a locally small type $B$, the image of $f$ is again essentially small.
\end{thm}

\subsection{Connected components of types}

\subsection{Set truncation}

\begin{lem}
For each type $A$, the relation $I_{(-1)}:A\to (A\to\prop)$ given by
\begin{equation*}
I_{(-1)}(x,y)\defeq\brck{x=y}
\end{equation*}
is an equivalence relation.
\end{lem}

\begin{proof}
For every $x:A$ we have $\bproj{\refl{x}}:\brck{x=x}$, so the relation is reflexive. To see that the relation is symmetric note that by the universal property of propositional truncation there is a unique map $\brck{\invfunc}:\brck{x=y}\to\brck{y=x}$ for which the square
\begin{equation*}
\begin{tikzcd}
(x=y) \arrow[r,"\invfunc"] \arrow[d,swap,"\bproj{\blank}"] & (y=x) \arrow[d,"\bproj{\blank}"] \\
\brck{x=y} \arrow[r,densely dotted,swap,"\brck{\invfunc}"] & \brck{y=x}
\end{tikzcd}
\end{equation*}
commutes. This shows that the relation is symmetric. Similarly, we show by the universal property of propositional truncation that the relation is transitive.
\end{proof}

\begin{defn}
For each type $A$ we define the \define{set truncation}
\begin{equation*}
\trunc{0}{A}\defeq A/I_{(-1)},
\end{equation*}
and the unit of the set truncation is defined to be the quotient map.
\end{defn}

\begin{thm}
For each type $A$, the set truncation satisfies the universal property of the set truncation.
\end{thm}

\begin{exercises}
\exercise
\begin{subexenum}
\item Show that any proposition is locally small.\index{proposition!is locally small}
\item Show that any essentially small type is locally small.\index{essentially small!type!is locally small}
\item Show that the function type $A\to X$ is locally small whenever $A$ is essentially small and $X$ is locally small.
\end{subexenum}
\exercise Let $f:A\to B$ be a map. Show that the following are equivalent:
\begin{enumerate}
\item The map $f$ is \define{locally small}\index{locally small!map} in the sense that for every $x,y:A$, the action on paths of $f$
\begin{equation*}
\apfunc{f}:(x=y)\to (f(x)=f(y))
\end{equation*}
is an essentially small map.
\item The diagonal $\delta_f$ of $f$ as defined in \cref{ex:trunc_diagonal_map} is classified by the universal fibration.
\end{enumerate}
\exercise \label{ex:span_rel}Use \cref{thm:choice,thm:fam_proj,cor:times_up_out} to show that the type 
\begin{equation*}
\mathsf{span}(A,B)\defeq \sm{S:\UU} (S\to A)\times (S\to B)
\end{equation*}
of small spans from $A$ to $B$ is equivalent to the type $A\to (B\to\UU)$ of small relations from $A$ to $B$.
\end{exercises}

\chapter{The fundamental theorem of identity types}
\chaptermark{The fundamental theorem}

\section{Fiberwise equivalences}
Consider a family
\begin{equation*}
f : \prd{x:A}B(x)\to C(x)
\end{equation*}
of maps. Such $f$ is also called a \define{fiberwise map} or \define{fiberwise transformation}.

\begin{defn}
We define a map
\begin{equation*}
\total{f}:\sm{x:A}B(x)\to\sm{x:A}C(x).
\end{equation*}
by $\lam{(x,y)}(x,f(x,y))$.
\end{defn}

\begin{lem}\label{lem:fib_total}
For any fiberwise transformation $f:\prd{x:A}B(x)\to C(x)$, and any $a:A$ and $c:C(a)$, there is an equivalence
\begin{equation*}
\eqv{\fib{f(a)}{c}}{\fib{\total{f}}{\pairr{a,c}}}.
\end{equation*}
\end{lem}

\begin{proof}
We first define a map $\varphi_{\pairr{a,c}}:{\fib{f(a)}{c}}\to \fib{\total{f}}{\pairr{a,c}}$ by $\Sigma$-induction.
It suffices to define a term of type
\begin{equation*}
\prd{b:B(a)} (f(a,b)=c)\to \fib{\total{f}}{\pairr{a,c}}
\end{equation*}
for every $a:A$ and $c:C(a)$. 
Since the endpoint of the identification $f(a,b)=c$ is free, we may proceed by path induction. 
It suffices to construct a term of type $\prd{b:B(a)} \fib{\total{f}}{\pairr{a,f(a,b)}}$.
For $b:B$, we take
\begin{equation*}
\pairr{\pairr{a,b},\refl{\pairr{a,f(a,b)}}}:\fib{\total{f}}{\pairr{a,f(a,b)}}.
\end{equation*}
Since we have defined $\varphi_{\pairr{a,c}}$ for all $a:A$ and $c:C(a)$, note that we also obtain a map
\begin{equation*}
\varphi_t:{\fib{f(\proj 1(t))}{\proj 2(t)}}\to \fib{\total{f}}{t}
\end{equation*}
for every $t:\sm{x:A}C(x)$.

Our next goal is to define a map
\begin{equation*}
\psi_{(a,c)}:{\fib{\total{f}}{a,c}}\to{\fib{f(a)}{c}}.
\end{equation*}
for every $a:A$ and $c:C(a)$. In fact it will be easier to construct more generally the map
\begin{equation*}
\psi_t : \fib{\total{f}}{t}\to \fib{f(\proj 1(t))}{\proj 2(t)}.
\end{equation*}
for every $t:\sm{x:A}C(x)$. Let us write $t_1\defeq \proj 1(t)$ and $t_2\defeq \proj 2(t)$.
By $\Sigma$-induction it suffices to construct a term of type
\begin{equation*}
\prd{s:\sm{x:A}B(x)} (\total{f}(s)=t)\to \fib{f(t_1)}{t_2},
\end{equation*}
We apply $\Sigma$-induction once more, and we need to construct a term of type
\begin{equation*}
\prd{x:A}{y:B(x)} (\total{f}(x,y)=t)\to \fib{f(t_1)}{t_2}.
\end{equation*}
Let $x:A$ and $y:B(x)$. Since the endpoint of the identification $\total{f}(x,y)=t$ is free, we proceed by path induction. Our goal is now to construct a term of type
\begin{equation*}
\fib{f(x)}{f(x,y)}. 
\end{equation*}
Here we simply take $\pairr{y,\refl{f(x,y)}}$, completing the construction of $\psi$.

To show that $\psi$ is a retraction of $\varphi$, we construct an identification 
\begin{equation*}
\psi(\varphi(\pairr{b,p}))=\pairr{b,p}
\end{equation*}
for each $b:B(a)$ and $p:f(a,b)=c$. We proceed by path induction on $p:f(a,b)=c$. Our goal is now to show that
\begin{equation*}
\psi(\varphi(b,\refl{f(a,b)}))=\pairr{b,\refl{f(a,b)}}
\end{equation*}
By definition we have
\begin{align*}
\varphi\pairr{b,\refl{f(a,b)}} & \jdeq \pairr{\pairr{a,b},\refl{\pairr{a,f(a,b)}}} \\
\psi\pairr{\pairr{a,b},\refl{\pairr{a,f(a,b)}}} & \jdeq\pairr{b,\refl{f(a,b)}}.
\end{align*}
Thus, we simply take $\refl{\pairr{b,\refl{f(a,b)}}}$ to complete the goal of showing that $\psi$ is a retraction of $\varphi$.

To show that $\psi_t$ is a section of $\varphi_t$ for every $t:\sm{x:A}C(x)$, we construct an identification 
\begin{equation*}
\varphi(\psi\pairr{\pairr{x,b},r})=\pairr{\pairr{x,b},r}
\end{equation*}
for each $x:A$, $y:B(x)$, and $r:\total{f}(x,y)=t$. 
We proceed by path induction on $r$, so our goal is to show
\begin{equation*}
\varphi(\psi(\pairr{x,y},\refl{\pairr{x,f(x,y)}}))=\pairr{x,f(x,y)}.
\end{equation*}
By definition we have
\begin{align*}
\psi(\pairr{x,y},\refl{\pairr{x,f(x,y)}})& \jdeq \pairr{y,\refl{f(x,y)}} \\
\varphi\pairr{y,\refl{f(x,y)}} & \jdeq \pairr{\pairr{x,y},\refl{\pairr{x,f(x,y)}}}
\end{align*}
Thus, we simply take $\refl{\pairr{x,f(x,y)}}$ to complete the goal of showing that $\psi$ is a section of $\varphi$.
\end{proof}

\begin{thm}\label{thm:fib_equiv}
Let $f:\prd{x:A}B(x)\to C(x)$ be a fiberwise transformation. The following are logically equivalent:
\begin{enumerate}
\item For each $x:A$, the map $f(x)$ is an equivalence. In this case we say that $f$ is a \define{fiberwise equivalence}.
\item The map $\total{f}:\sm{x:A}B(x)\to\sm{x:A}C(x)$ is an equivalence.
\end{enumerate}
\end{thm}

\begin{proof}
By \cref{thm:equiv_contr,thm:contr_equiv} it suffices to show that $f(x)$ is a contractible map for each $x:A$, if and only if $\total{f}$ is a contractible map. Thus, we will show that $\fib{f(x)}{c}$ is contractible if and only if $\fib{\total{f}}{x,c}$ is contractible, for each $x:A$ and $c:C(x)$. However, by \autoref{lem:fib_total} these types are equivalent, so the result follows by \cref{ex:contr_equiv}.
\end{proof}

\section{The fundamental theorem}

\begin{thm}\label{thm:id_fundamental}
Let $A$ be a type with $a:A$, and let $B$ be be a type family over $A$ with $b:B(a)$.
Then  the following are logically equivalent:
\begin{enumerate}
\item The canonical family of maps
\begin{equation*}
\rec{a{=}}(b):\prd{x:A} (a=x)\to B(x)
\end{equation*}
is a fiberwise equivalence.
\item The total space
\begin{equation*}
\sm{x:A}B(x)
\end{equation*}
is contractible.
\end{enumerate}
\end{thm}

\begin{proof}
By \autoref{thm:fib_equiv} it follows that the fiberwise transformation $\rec{a{=}}(b)$ is a fiberwise equivalence if and only if it induces an equivalence
\begin{equation*}
\eqv{\Big(\sm{x:A}a=x\Big)}{\Big(\sm{x:A}B(x)\Big)}
\end{equation*}
on total spaces. We have that $\sm{x:A}a=x$ is contractible. Now it follows by \cref{ex:contr_equiv}, applied in the case
\begin{equation*}
\begin{tikzcd}
\sm{x:A}a=x \arrow[rr,"\total{\rec{a{=}}(b)}"] \arrow[dr,swap,"\eqvsym"] & & \sm{x:A}B(x) \arrow[dl] \\
& \unit
\end{tikzcd}
\end{equation*}
that $\total{\rec{a{=}}(b)}$ is an equivalence if and only if $\sm{x:A}B(x)$ is contractible.
\end{proof}

As an application of the fundamental theorem we show that equivalences are embeddings. The notion embeddings is the homotopically correct notion of injective maps.

\begin{defn}
An \define{embedding}\index{embedding|textbf} is a map $f:A\to B$ satisfying the property that
\begin{equation*}
\apfunc{f}:(\id{x}{y})\to(\id{f(x)}{f(y)})
\end{equation*}
is an equivalence for every $x,y:A$. We write $\mathsf{is\usc{}emb}(f)$ for the type of witnesses that $f$ is an embedding.
\end{defn}

\begin{thm}
\label{cor:emb_equiv} 
Any equivalence is an embedding.\index{embedding!equivalences are embeddings|textit}\index{equivalence!is an embedding|textit}
\end{thm}

\begin{proof}
Let $e:\eqv{A}{B}$ be an equivalence, and let $x:A$. Our goal is to show that
\begin{equation*}
\apfunc{e} : (\id{x}{y})\to (\id{e(x)}{e(y)})
\end{equation*}
is an equivalence for every $y:A$. By \autoref{thm:id_fundamental} it suffices to show that 
\begin{equation*}
\sm{y:A}e(x)=e(y)
\end{equation*}
is contractible for every $y:A$. Now observe that there is an equivalence
\begin{samepage}
\begin{align*}
\sm{y:A}e(x)=e(y) & \eqvsym \sm{y:A}e(y)=e(x) \\
& \jdeq \fib{e}{e(x)}
\end{align*}
\end{samepage}
by \cref{thm:fib_equiv}, since for each $y:A$ the map
\begin{equation*}
\mathsf{inv} : (e(x)=e(y))\to (e(y)= e(x))
\end{equation*}
is an equivalence by \cref{ex:equiv_grpd_ops}.
The fiber $\fib{e}{e(x)}$ is contractible by \cref{thm:contr_equiv}, so it follows by \autoref{ex:contr_equiv} that the type $\sm{y:A}e(x)=e(y)$ is indeed contractible.
\end{proof}

\begin{comment}
As a first application of the fundamental theorem, we compute the identity type of a disjoint sum.
This illustrates in a simple case the most important technique of computing the identity type of a type, that is also called the \emph{encode-decode method}.

\begin{defn}
Let $A$ and $B$ be types in $\UU$. We construct equivalences
\begin{align*}
(\id[A+B]{\inl(x)}{\inl(x')}) & \eqvsym (\id[A]{x}{x'}) \\
(\id[A+B]{\inl(x)}{\inr(y')}) & \eqvsym \emptyt \\
(\id[A+B]{\inr(y)}{\inl(x')}) & \eqvsym \emptyt \\
(\id[A+B]{\inr(y)}{\inr(y')}) & \eqvsym (\id[B]{y}{y'}).
\end{align*}
\end{defn}

\begin{constr}
We define by double induction on the disjoint sum the binary relation
\begin{equation*}
E : (A+B)\to (A+B)\to\UU
\end{equation*}
given by
\begin{align*}
E({\inl(x)},{\inl(x')}) & \defeq \id[A]{x}{x'} \\
E({\inl(x)},{\inr(y')}) & \defeq \emptyt \\
E({\inr(y)},{\inl(x')}) & \defeq \emptyt \\
E({\inr(y)},{\inr(y')}) & \defeq (\id[B]{y}{y'}).
\end{align*}
Moreover, we have a term $\rho:\prd{s:A+B}E(s,s)$ defined by $\rho(\inl(x))\defeq\refl{x}$ and $\rho(\inr(y))\defeq\refl{y}$.

Our goal is to construct an equivalence $\eqv{(\id{s}{t})}{E(s,t)}$ for any $s,t:A+B$. 
By \autoref{thm:id_fundamental} it suffices to show that for any $s:A+B$, the type
\begin{equation*}
\sm{t:A+B}E(s,t)
\end{equation*}
is contractible. The center of contraction is taken to be $\pairr{s,\rho(s)}$, so it remains to construct the contraction
\begin{equation*}
\prd{t:A+B}{e:E(s,t)} \pairr{s,\rho(s)}=\pairr{t,e}.
\end{equation*}
This is done by induction on $s$ and $t$, so we have to show that
\begin{align*}
& \prd{x':A}{p:x=x'} \pairr{\inl(x),\refl{x}}=\pairr{x',p} \\
& \prd{y':A}{q:\emptyt} \pairr{\inl(x),\refl{x}}=\pairr{y',q} \\
& \prd{x':A}{q:\emptyt} \pairr{\inr(y),\refl{y}}=\pairr{x',q} \\
& \prd{y':A}{p:y=y'} \pairr{\inr(y),\refl{y}}=\pairr{y',p}.
\end{align*}
The first and fourth case are easily shown by path induction on $p$, and the second and third case are easily shown by induction on the empty type.
\end{constr}
\end{comment}

\begin{exercises}
\item \label{ex:htpy_total} 
\begin{subexenum}
\item Let $f,g:\prd{x:A}B(x)\to C(x)$ be two fiberwise transformations. Show that
\begin{equation*}
\Big(\prd{x:A}f(x)\htpy g(x)\Big)\to (\total{f}\htpy \total{g}). 
\end{equation*}
\item Let $f:\prd{x:A}B(x)\to C(x)$ and let $g:\prd{x:A}C(x)\to D(x)$. Show that
\begin{equation*}
\total{\lam{x}g(x)\circ f(x)}\htpy \total{g}\circ\total{f}.
\end{equation*}
\item For any family $B$ over $A$, show that
\begin{equation*}
\total{\lam{x}\idfunc[B(x)]}\htpy\idfunc[\sm{x:A}B(x)].
\end{equation*}
\end{subexenum}
\item Construct an equivalence 
\begin{equation*}
\eqv{\big(\sm{x:A}f(x)=y\big)}{\big(\sm{x:A}y=f(x)\big)}.
\end{equation*}
%Conclude that $\sm{x:A}a=x$ is contractible for any $a:A$.
\item \label{ex:fiber_trans}Consider a triangle
\begin{equation*}
\begin{tikzcd}[column sep=small]
A \arrow[rr,"h"] \arrow[dr,swap,"f"] & & B \arrow[dl,"g"] \\
& X
\end{tikzcd}
\end{equation*}
with a homotopy $H:f\htpy g\circ h$ witnessing that the triangle commutes. 
\begin{subexenum}
\item Construct a fiberwise transformation
\begin{equation*}
\mathsf{fib\usc{}triangle}(h,H):\prd{x:X}\fib{f}{x}\to\fib{g}{x},
\end{equation*}
for which the square
\begin{equation*}
\begin{tikzcd}[column sep=8em]
\sm{x:X}\fib{f}{x} \arrow[r,"\total{\mathsf{fib\usc{}triangle}(h,H)}"] \arrow[d] & \sm{x:X}\fib{g}{x} \arrow[d] \\
A \arrow[r,swap,"h"] & B
\end{tikzcd}
\end{equation*}
commutes, where the vertical maps are as constructed in \cref{ex:fib_replacement}.
\item Show that $h$ is an equivalence if and only if $\mathsf{fib\usc{}triangle}(h,H)$ is a fiberwise equivalence.
\end{subexenum}
\item Let $f:A\to B$ be a map, and let $s,t : \fib{f}{b}$. Consider the function
\begin{equation*}
\varphi : (s=t)\to \fib{\apfunc{f}}{\ct{\proj 2(s)}{\proj 2(t)^{-1}}}
\end{equation*}
given by $\varphi(\refl{s})=(\refl{\proj 1(s)},\mathsf{right\usc{}inv}(\proj 2(s))^{-1})$. Show that this map is an equivalence. Conclude that for any $q:f(x)=f(y)$ we have an equivalence
\begin{equation*}
((x,q)=(y,\refl{f(y)})) \simeq \fib{\apfunc{f}}{q}.
\end{equation*}
\item \label{ex:id_fundamental_gen}Let $A$ be a type with $a:A$, and let $B$ be a type family over $A$. Show that for \emph{any} family of maps
\begin{equation*}
f:\prd{x:A} (a=x)\to B(x)
\end{equation*}
the following are logically equivalent:
\begin{enumerate}
\item The family of maps $f$ is a fiberwise equivalence.
\item The total space
\begin{equation*}
\sm{x:A}B(x)
\end{equation*}
is contractible.
\end{enumerate}
\item \label{ex:id_fundamental_retr}Let $a:A$, and let $B$ be a type family over $A$. 
\begin{subexenum}
\item Use \autoref{ex:htpy_total,ex:contr_retr,ex:id_fundamental_gen} to show that if each $B(x)$ is a retract of $\id{a}{x}$, then $B(x)$ is equivalent to $\id{a}{x}$ for every $x:A$.
\item Conclude that for any fiberwise transformation
\begin{equation*}
f : \prd{x:A} (a=x) \to B(x),
\end{equation*}
if each $f(x)$ has a section, then $f$ is a fiberwise equivalence.
\end{subexenum}
\item Show that the map $\emptyt\to A$ is an embedding for every type $A$.
\item Show that 
\begin{equation*}
(f\htpy g)\to (\mathsf{is\usc{}emb}(f)\leftrightarrow\mathsf{is\usc{}emb}(g))
\end{equation*}
for any $f,g:A\to B$.
\item \label{ex:emb_triangle}Consider a commuting triangle
\begin{equation*}
\begin{tikzcd}[column sep=tiny]
A \arrow[rr,"h"] \arrow[dr,swap,"f"] & & B \arrow[dl,"g"] \\
& X
\end{tikzcd}
\end{equation*}
with $H:f\htpy g\circ h$. 
\begin{subexenum}
\item Suppose that $g$ is an embedding. Show that $f$ is an embedding if and only if $h$ is an embedding.
\item Supose that $h$ is an equivalence. Show that $f$ is an embedding if and only if $g$ is an embedding.
\end{subexenum}
\item Use \cref{ex:id_fundamental_retr} to show that for any map $f:A\to B$, if
\begin{equation*}
\apfunc{f} : (x=y) \to (f(x)=f(y))
\end{equation*}
has a section for each $x,y:A$, then $f$ is an embedding.
\item \label{ex:eqv_sigma_mv}Consider a map
\begin{equation*}
f:A \to \sm{y:B}C(y).
\end{equation*}
\begin{subexenum}
\item Construct a fiberwise transformation
\begin{equation*}
f':\prd{y:B} \fib{\proj 1\circ f}{y}\to C(y).
\end{equation*}
\item Construct an equivalence
\begin{equation*}
\eqv{\fib{f'(b)}{c}}{\fib{f}{(b,c)}}
\end{equation*}
for every $(b,c):\sm{y:B}C(y)$.
\item Conclude that the following are equivalent:
\begin{enumerate}
\item $f$ is an equivalence.
\item $f'$ is a fiberwise equivalence.
\end{enumerate}
\end{subexenum}
\item \label{ex:coh_intro}Consider a type $A$ with base point $a:A$, and let $B$ be a type family on $A$ that implies the identity type, i.e.~there is a term
\begin{equation*}
\alpha : \prd{x:A} B(x)\to (a=x).
\end{equation*}
Show that the \define{coherence reduction map}
\begin{equation*}
\mathsf{coh\usc{}red} : \Big(\sm{y:B(a)}\alpha(a,y)=\refl{a}\Big) \to \Big(\sm{x:A}B(x)\Big)
\end{equation*}
defined by $\lam{(y,q)}(a,y)$ is an equivalence.
\end{exercises}
